<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planning de garde - Grand-p√®re</title>
    <!-- Anti-cache fort -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .week-selector { margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 20px; }
        .week-selector button { background: rgba(255,255,255,0.2); border: 2px solid #fff; color: #fff; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 1.1em; transition: all 0.3s; }
        .week-selector button:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .week-display { font-size: 1.2em; font-weight: bold; min-width: 200px; text-align: center; }
        .vacation-section {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .vacation-section h3 { color: #2d3436; margin-bottom: 15px; font-size: 1.3em; }
        .vacation-list { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .vacation-person { background: white; padding: 10px 20px; border-radius: 25px; display: flex; align-items: center; gap: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        .vacation-person .vacation-icon { font-size: 1.2em; }
        .no-vacation { color: #636e72; font-style: italic; padding: 10px; }
        .content { padding: 30px; }
        .controls { margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 12px 25px; border: none; border-radius: 25px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-success { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #2c3e50; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .table-container { overflow-x: auto; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; }
        th { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 15px; text-align: center; font-weight: bold; color: #333; position: sticky; top: 0; z-index: 10; }
        th:first-child { border-top-left-radius: 15px; }
        th:last-child { border-top-right-radius: 15px; }
        td { padding: 12px; text-align: center; border: 1px solid #e0e0e0; background: #fff; position: relative; vertical-align: top; }
        .time-slot { background: #f8f9fa; font-weight: bold; color: #495057; }
        .slot { min-height: 120px; cursor: pointer; transition: all 0.3s; position: relative; padding: 10px; }
        .slot:hover { background: #f0f4ff; }
        .assignment { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); color: #2d3436; padding: 8px; border-radius: 10px; margin: 5px 2px; display: block; animation: slideIn 0.3s ease-out; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: left; }
        .assignment.task-courses { background: linear-gradient(135deg, #fab1a0 0%, #ff7675 100%); }
        .assignment.task-repas { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: #fff; }
        .assignment.task-menage { background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); color: #fff; }
        .assignment.task-soins { background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); color: #fff; }
        .assignment.task-compagnie { background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); color: #fff; }
        .assignment.task-administratif { background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%); }
        .assignment.task-transport { background: linear-gradient(135deg, #81ecec 0%, #00cec9 100%); }
        .assignment.task-autre { background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%); }
        .assignment-person { font-weight: bold; font-size: 0.95em; }
        .assignment-task { font-size: 0.85em; opacity: 0.9; margin-top: 2px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
        .side-panel { position: fixed; right: -400px; top: 0; width: 400px; height: 100vh; background: #fff; box-shadow: -5px 0 20px rgba(0,0,0,0.1); transition: right 0.3s; z-index: 1000; overflow-y: auto; }
        .side-panel.active { right: 0; }
        .panel-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 20px; position: sticky; top: 0; z-index: 11; }
        .panel-content { padding: 20px; }
        .panel-section { margin-bottom: 30px; }
        .panel-section h4 { margin-bottom: 15px; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .person-item, .task-item {
            padding: 12px; margin: 10px 0; background: #f8f9fa; border-radius: 10px; transition: all 0.3s; border: 2px solid transparent; display: flex; align-items: center; justify-content: space-between;
        }
        .person-item.on-vacation { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); opacity: 0.7; }
        .person-item-content { display: flex; align-items: center; gap: 10px; flex: 1; }
        .person-item-name { flex: 1; }
        .vacation-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: #f39c12; }
        .vacation-label { font-size: 0.85em; color: #666; cursor: pointer; user-select: none; }
        .person-item:hover, .task-item:hover { transform: translateX(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #667eea; }
        .task-item { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
        .task-item.task-courses { border-left: 4px solid #ff7675; }
        .task-item.task-repas { border-left: 4px solid #0984e3; }
        .task-item.task-menage { border-left: 4px solid #6c5ce7; }
        .task-item.task-soins { border-left: 4px solid #00b894; }
        .task-item.task-compagnie { border-left: 4px solid #e84393; }
        .task-item.task-administratif { border-left: 4px solid #f39c12; }
        .task-item.task-transport { border-left: 4px solid #00cec9; }
        .task-item.task-autre { border-left: 4px solid #b2bec3; }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        .add-form { margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0; }
        .add-form input, .add-form select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; margin-bottom: 10px; transition: border-color 0.3s; }
        .add-form input:focus, .add-form select:focus { outline: none; border-color: #667eea; }
        .slot.drag-over { background: #e8f5e9; border: 2px dashed #4caf50; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: #fff; color: #667eea; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2em; transition: all 0.3s; }
        .close-btn:hover { background: #f0f0f0; transform: rotate(90deg); }
        .remove-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  line-height: 1;
  border: none;
  background: rgba(220, 53, 69, 0.1);
  border-radius: 6px;
  font-weight: 700;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.remove-btn:active { transform: scale(0.96); }
        .remove-btn:hover { background: rgba(220, 53, 69, 0.1); }
        .delete-btn { color: #dc3545; cursor: pointer; padding: 2px 8px; background: rgba(220, 53, 69, 0.1); border-radius: 5px; transition: all 0.3s; }
        .delete-btn:hover { background: rgba(220, 53, 69, 0.2); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out; }
        @keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { margin-bottom: 20px; }
        .modal-header h3 { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #666; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .legend { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px; }
        .legend h4 { margin-bottom: 15px; color: #333; }
        .legend-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .legend-item { display: flex; align-items: center; gap: 10px; }
        .legend-color { width: 30px; height: 20px; border-radius: 5px; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .controls { flex-direction: column; align-items: stretch; }
            .side-panel { width: 100%; right: -100%; }
            .modal-content { padding: 20px; }
            .vacation-list { flex-direction: column; }
        }
        .icon-btn {
  border: none; background: transparent; cursor: pointer;
  font-size: 14px; padding: 6px; border-radius: 6px;
}
.icon-btn:hover { background: rgba(0,0,0,0.06); }
.item-actions { display: flex; gap: 6px; align-items: center; }
.inline-edit {
  width: 100%; padding: 6px 8px; border: 2px solid #e0e0e0; border-radius: 8px;
}
.inline-edit:focus { outline: none; border-color: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Planning de garde et t√¢ches</h1>
            <div class="week-selector">
                <button onclick="changeWeek(-1)">‚Üê Semaine pr√©c√©dente</button>
                <div class="week-display" id="weekDisplay"></div>
                <button onclick="changeWeek(1)">Semaine suivante ‚Üí</button>
            </div>
        </div>
        <div class="vacation-section">
            <h3>üèñÔ∏è Personnes en vacances cette semaine</h3>
            <div class="vacation-list" id="vacationList">
                <div class="no-vacation">Aucune personne en vacances cette semaine</div>
            </div>
        </div>
        <div class="content">
            <div class="controls">
                <button class="btn btn-primary" onclick="togglePanel()">üë• Personnes et T√¢ches</button>
                <button class="btn btn-success" onclick="openAssignmentModal()">‚ûï Ajouter une attribution</button>
                <button class="btn btn-secondary" onclick="clearWeek()">üóëÔ∏è Effacer la semaine</button>
                <button class="btn btn-secondary" onclick="exportPlanning()">üì• Exporter le planning</button>
            </div>
            <div class="table-container">
                <table id="planningTable">
                    <thead>
                        <tr id="headerRow">
                            <th>Horaire</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr id="morningRow">
                            <td class="time-slot">Matin<br>(8h-12h)</td>
                        </tr>
                        <tr id="afternoonRow">
                            <td class="time-slot">Apr√®s-midi<br>(14h-18h)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="legend">
                <h4>üìå L√©gende des t√¢ches</h4>
                <div class="legend-items">
                    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #fab1a0 0%, #ff7675 100%);"></div><span>Courses</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);"></div><span>Repas</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);"></div><span>M√©nage</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);"></div><span>Soins</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);"></div><span>Compagnie</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);"></div><span>Administratif</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #81ecec 0%, #00cec9 100%);"></div><span>Transport</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);"></div><span>Autre</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="side-panel" id="sidePanel">
        <button class="close-btn" onclick="togglePanel()">√ó</button>
        <div class="panel-header"><h3>Gestion des personnes et t√¢ches</h3></div>
        <div class="panel-content">
            <div class="panel-section">
                <h4>üë• Personnes disponibles</h4>
                <div id="peopleContainer"></div>
                <div class="add-form">
                    <input type="text" id="newPersonName" placeholder="Nom de la personne" onkeypress="if(event.key==='Enter') addPerson()" />
                    <button class="btn btn-primary" style="width: 100%;" onclick="addPerson()">‚ûï Ajouter une personne</button>
                </div>
            </div>
            <div class="panel-section">
                <h4>üìã T√¢ches disponibles</h4>
                <div id="tasksContainer"></div>
                <div class="add-form">
                    <input type="text" id="newTaskName" placeholder="Nouvelle t√¢che" onkeypress="if(event.key==='Enter') addTask()" />
                    <select id="newTaskCategory">
                        <option value="courses">üõí Courses</option>
                        <option value="repas">üçΩÔ∏è Repas</option>
                        <option value="menage">üßπ M√©nage</option>
                        <option value="soins">üíä Soins</option>
                        <option value="compagnie">üë• Compagnie</option>
                        <option value="administratif">üìÑ Administratif</option>
                        <option value="transport">üöó Transport</option>
                        <option value="autre">üìå Autre</option>
                    </select>
                    <button class="btn btn-primary" onclick="addTask()" style="width: 100%;">‚ûï Ajouter une t√¢che</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="assignmentModal">
        <div class="modal-content">
            <div class="modal-header"><h3>‚ûï Nouvelle attribution</h3></div>
            <div class="form-group">
                <label>Jour de la semaine</label>
                <select id="modalDay">
                    <option value="Lundi">Lundi</option>
                    <option value="Mardi">Mardi</option>
                    <option value="Mercredi">Mercredi</option>
                    <option value="Jeudi">Jeudi</option>
                    <option value="Vendredi">Vendredi</option>
                    <option value="Samedi">Samedi</option>
                    <option value="Dimanche">Dimanche</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cr√©neau horaire</label>
                <select id="modalPeriod">
                    <option value="morning">Matin (8h-12h)</option>
                    <option value="afternoon">Apr√®s-midi (14h-18h)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Personne</label>
                <select id="modalPerson"></select>
            </div>
            <div class="form-group">
                <label>T√¢che</label>
                <select id="modalTask"></select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAssignmentModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveAssignment()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- ==== JS complet (module) ==== -->
    <script type="module">
        // Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2MjMWssWKh74NIru2wAvR3rPZ6eFH854",
            authDomain: "plnning-familial.firebaseapp.com",
            projectId: "plnning-familial",
            storageBucket: "plnning-familial.firebasestorage.app",
            messagingSenderId: "97302700143",
            appId: "1:97302700143:web:f50693e7cd5ef514a4ed9a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const listsDocRef = doc(db, "plannings_meta", "lists");
// --- Planning hebdo (un doc par semaine) ---
function planningDocRef(weekKey) {
  return doc(db, "plannings", weekKey);
}
let unsubscribePlanning = null;

function renderWeekFromData(weekData) {
  // vide les slots puis rend tout
  clearSlotsOnly();
  if (!weekData) return;
  Object.entries(weekData).forEach(([day, periods]) => {
    Object.entries(periods).forEach(([period, list]) => {
      const slot = document.querySelector(`.slot[data-day="${day}"][data-period="${period}"]`);
      if (!slot) return;
      (list || []).forEach(item => {
        // si personne en vacances c√¥t√© client, on n'affiche pas (s√©curit√©)
        const weekVac = vacations[getWeekKey()] || {};
        if (weekVac[item.person]) return;
        slot.appendChild(renderAssignment(item));
      });
    });
  });
}

function subscribeToWeekPlanning() {
  const ref = planningDocRef(getWeekKey());
  if (unsubscribePlanning) { unsubscribePlanning(); unsubscribePlanning = null; }
  unsubscribePlanning = onSnapshot(ref, (snap) => {
    if (snap.exists()) {
      const payload = snap.data();
      renderWeekFromData(payload?.data || {});
    } else {
      // aucune donn√©e cloud pour cette semaine -> on garde l'affichage actuel/local
      clearSlotsOnly();
    }
  }, (err) => {
    console.warn("onSnapshot planning error:", err);
  });
}
        async function saveListsToCloud() {
            try {
                await setDoc(listsDocRef, { people, tasks }, { merge: true });
                console.log("‚òÅÔ∏è Listes people/tasks sauvegard√©es dans Firestore");
            } catch (err) {
                console.warn("‚ö†Ô∏è saveListsToCloud √©chec -> reste local:", err);
            }
        }

        async function loadListsFromCloud() {
            try {
                const snap = await getDoc(listsDocRef);
                if (snap.exists()) {
                    const data = snap.data();
                    if (Array.isArray(data.people)) people = data.people;
                    if (Array.isArray(data.tasks)) tasks = data.tasks;
                    console.log("‚òÅÔ∏è Listes people/tasks charg√©es depuis Firestore");
                    localStorage.setItem('people', JSON.stringify(people));
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    return true;
                }
            } catch (err) {
                console.warn("‚ö†Ô∏è loadListsFromCloud: impossible de lire Firestore:", err);
            }
            return false;
        }
let unsubscribeLists = null;
function subscribeToLists() {
  if (unsubscribeLists) { unsubscribeLists(); unsubscribeLists = null; }
  unsubscribeLists = onSnapshot(listsDocRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.data() || {};
    if (Array.isArray(data.people)) {
      people = data.people;
      localStorage.setItem('people', JSON.stringify(people));
    }
    if (Array.isArray(data.tasks)) {
      tasks = data.tasks;
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }
    updatePeopleList();
    updateTasksList();
    refreshModalOptions();
  }, (err) => console.warn("onSnapshot lists error:", err));
}
        // === Helpers Vacances / Storage ===
        const STORAGE_KEYS = {
            vacations: 'vacations_by_week',
            planning: 'planning_by_week',
        };

        function getWeekKey() { return getWeekDates().key; }

        function loadVacationsFromLocal() {
            try { const raw = localStorage.getItem(STORAGE_KEYS.vacations); return raw ? JSON.parse(raw) : {}; } catch { return {}; }
        }
        function saveVacationsToLocal() {
            try { localStorage.setItem(STORAGE_KEYS.vacations, JSON.stringify(vacations)); } catch {}
        }
        function removeAssignmentsForPersonThisWeek(personName) {
            document.querySelectorAll('.slot').forEach(slot => {
                slot.querySelectorAll('.assignment').forEach(a => {
                    const p = a.querySelector('.assignment-person')?.textContent || '';
                    if (p === personName) a.remove();
                });
            });
            savePlanning();
        }
// --- Renommer une personne partout (liste + attributions DOM + Firestore) ---
function renamePerson(oldName, newName) {
  const trimmed = (newName || '').trim();
  if (!trimmed) return;
  if (people.includes(trimmed)) return; // √©vite doublon

  // 1) Liste people
  const idx = people.indexOf(oldName);
  if (idx >= 0) people[idx] = trimmed;

  // 2) Mettre √† jour toutes les attributions visibles cette semaine
  document.querySelectorAll('.assignment .assignment-person').forEach(el => {
    if (el.textContent === oldName) el.textContent = trimmed;
  });

  // 3) Sauvegardes
  localStorage.setItem('people', JSON.stringify(people));
  saveListsToCloud();
  savePlanning(); // pousse la version corrig√©e vers Firestore pour cette semaine

  // 4) Vacances : renomme la cl√© si coch√©e pour la semaine
  const wk = getWeekKey();
  if (vacations[wk]?.[oldName]) {
    vacations[wk][trimmed] = vacations[wk][oldName];
    delete vacations[wk][oldName];
    saveVacationsToLocal();
  }

  // 5) UI
  updatePeopleList();
  refreshModalOptions();
  updateVacationDisplay();
}

// --- Renommer une t√¢che partout (liste + attributions DOM + Firestore) ---
function renameTask(oldTaskName, newTaskName) {
  const trimmed = (newTaskName || '').trim();
  if (!trimmed) return;

  // 1) Liste tasks (garde la cat√©gorie d‚Äôorigine)
  const t = tasks.find(x => x.name === oldTaskName);
  if (t) t.name = trimmed;

  // 2) Mettre √† jour toutes les attributions visibles cette semaine
  document.querySelectorAll('.assignment .assignment-task').forEach(el => {
    if (el.textContent === oldTaskName) el.textContent = trimmed;
  });

  // 3) Sauvegardes
  localStorage.setItem('tasks', JSON.stringify(tasks));
  saveListsToCloud();
  savePlanning(); // pousse la version corrig√©e vers Firestore pour cette semaine

  // 4) UI
  updateTasksList();
  refreshModalOptions();
}
        // === Fonction loadSavedData (appel√©e par initTable) ===
        async function loadSavedData() {
            const cloudOK = await loadListsFromCloud();
            const sp = localStorage.getItem('people');
            if (!cloudOK && sp) people = JSON.parse(sp);
            const st = localStorage.getItem('tasks');
            if (!cloudOK && st) tasks = JSON.parse(st);
            vacations = loadVacationsFromLocal();
        }

        // === Donn√©es ===
        let currentWeekOffset = 0;
        let people = ['Nassera', 'Karima', 'Nadera', 'Messaoud', 'Mehdi'];
        let tasks = [
            { name: 'Faire les courses', category: 'courses' },
            { name: 'Pr√©parer le d√©jeuner', category: 'repas' },
            { name: 'Pr√©parer le d√Æner', category: 'repas' },
            { name: 'Faire le m√©nage', category: 'menage' },
            { name: 'Laver le linge', category: 'menage' },
            { name: 'Donner les m√©dicaments', category: 'soins' },
            { name: 'Tenir compagnie', category: 'compagnie' },
            { name: 'Rendez-vous m√©dical', category: 'transport' },
            { name: 'Papiers administratifs', category: 'administratif' },
        ];
        let vacations = {}; // { weekKey: { personName: true } }
        let draggedElem = null; // pour d√©placer une attribution existante

        // Init DOM
        document.addEventListener('DOMContentLoaded', () => { initTable(); });

        // === Construction du tableau ===
        async function initTable() {
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const headerRow = document.getElementById('headerRow');
            const morningRow = document.getElementById('morningRow');
            const afternoonRow = document.getElementById('afternoonRow');

            // √©vite la double cr√©ation si re-init
            headerRow.querySelectorAll('th:not(:first-child)').forEach(th => th.remove());
            morningRow.querySelectorAll('td.slot').forEach(td => td.remove());
            afternoonRow.querySelectorAll('td.slot').forEach(td => td.remove());

            days.forEach((day) => {
                const th = document.createElement('th'); th.textContent = day; headerRow.appendChild(th);
                const morningTd = createSlot(day, 'morning'); morningRow.appendChild(morningTd);
                const afternoonTd = createSlot(day, 'afternoon'); afternoonRow.appendChild(afternoonTd);
            });

            await loadSavedData();
            updateWeekDisplay();
            loadPlanning();            // fallback local imm√©diat
subscribeToWeekPlanning(); // puis √©coute temps r√©el cloud
            updatePeopleList();
            updateTasksList();
            refreshModalOptions();
            updateVacationDisplay();
            subscribeToLists();
        }

        function createSlot(day, period) {
            const td = document.createElement('td');
            td.className = 'slot';
            td.dataset.day = day; td.dataset.period = period;
            td.ondrop = drop; td.ondragover = allowDrop; td.ondragleave = dragLeave;
            return td;
        }

        // === Gestion des semaines ===
        function getWeekDates() {
            const today = new Date();
            const currentDay = today.getDay() || 7; // 1=Lundi .. 7=Dimanche
            const monday = new Date(today);
            monday.setHours(0, 0, 0, 0);
            monday.setDate(today.getDate() - currentDay + 1 + currentWeekOffset * 7);
            const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
            // Mois 0-based : garde tel quel pour la cl√© (stable)
            return { start: monday, end: sunday, key: `${monday.getFullYear()}-${monday.getMonth()}-${monday.getDate()}` };
        }

        function updateWeekDisplay() {
            const dates = getWeekDates();
            const options = { day: 'numeric', month: 'short' };
            const startStr = dates.start.toLocaleDateString('fr-FR', options);
            const endStr = dates.end.toLocaleDateString('fr-FR', options);
            document.getElementById('weekDisplay').textContent = `${startStr} - ${endStr}`;
        }

        function changeWeek(offset) {
  savePlanning();            // sauvegarde la semaine courante
  currentWeekOffset += offset;
  updateWeekDisplay();
  clearSlotsOnly();
  loadPlanning();            // fallback local
  subscribeToWeekPlanning(); // √©coute du nouveau doc Firestore
  updateVacationDisplay();
  updatePeopleList();
  refreshModalOptions();
}

        // === Helpers DOM ‚Üî objet planning ===
        function buildWeekPlanningFromDOM() {
            const weekPlanning = {};
            document.querySelectorAll('.slot').forEach((slot) => {
                const day = slot.dataset.day; const period = slot.dataset.period;
                const assignments = Array.from(slot.querySelectorAll('.assignment')).map((el) => {
                    const person = el.querySelector('.assignment-person').textContent;
                    const task = el.querySelector('.assignment-task').textContent;
                    const category = Array.from(el.classList).find((c) => c.startsWith('task-'))?.replace('task-', '') || 'autre';
                    return { person, task, category };
                });
                if (!weekPlanning[day]) weekPlanning[day] = {};
                weekPlanning[day][period] = assignments;
            });
            return weekPlanning;
        }

        function renderAssignment(obj) {
            const div = document.createElement('div');
            div.className = `assignment task-${obj.category || 'autre'}`;
            div.draggable = true;
            div.addEventListener('dragstart', (e) => {
  // Si le point de d√©part est sur le bouton supprimer, on annule le drag
  if (e.target && e.target.closest('.remove-btn')) {
    e.preventDefault();
    return;
  }
  draggedElem = div;
  div.classList.add('dragging');
});
            div.addEventListener('dragend', () => { draggedElem = null; div.classList.remove('dragging'); });
            div.innerHTML = `
    <span class="assignment-person">${obj.person}</span>
    <button class="remove-btn" type="button" title="Supprimer" aria-label="Supprimer" draggable="false">√ó</button>
    <div class="assignment-task">${obj.task}</div>
`;
             div.style.paddingRight = '6px';
            div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); savePlanning(); });
            return div;
        }

        // === Persistance planning par semaine (localStorage) ===
        async function savePlanning() {
  const key = STORAGE_KEYS.planning + ':' + getWeekKey();
  const data = buildWeekPlanningFromDOM();
  // local (fallback)
  try { localStorage.setItem(key, JSON.stringify(data)); } catch {}

  // cloud (temps r√©el inter-appareils)
  try {
    await setDoc(planningDocRef(getWeekKey()), {
      data,
      updatedAt: Date.now()
    }, { merge: true });
  } catch (e) {
    console.warn("savePlanning -> Firestore KO, reste local:", e);
  }
}

        function loadPlanning() {
  const key = STORAGE_KEYS.planning + ':' + getWeekKey();
  const raw = localStorage.getItem(key);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    renderWeekFromData(data);
  } catch {}
}

        function clearSlotsOnly() {
            document.querySelectorAll('.slot').forEach(slot => slot.innerHTML = '');
        }

        // === Gestion des vacances ===
        function toggleVacation(personName) {
            const weekKey = getWeekKey();
            if (!vacations[weekKey]) vacations[weekKey] = {};
            const newState = !vacations[weekKey][personName];
            vacations[weekKey][personName] = newState;
            saveVacationsToLocal();
            if (newState) removeAssignmentsForPersonThisWeek(personName);
            updatePeopleList();
            updateVacationDisplay();
            refreshModalOptions();
        }

        function updateVacationDisplay() {
            const list = document.getElementById('vacationList');
            list.innerHTML = '';
            const weekKey = getWeekKey();
            const weekVac = vacations[weekKey] || {};
            const vacNames = (people || []).filter(p => weekVac[p]);
            if (!vacNames.length) {
                const div = document.createElement('div');
                div.className = 'no-vacation';
                div.textContent = 'Aucune personne en vacances cette semaine';
                list.appendChild(div);
                return;
            }
            vacNames.forEach(name => {
                const item = document.createElement('div');
                item.className = 'vacation-person';
                item.innerHTML = `<span class="vacation-icon">üèñÔ∏è</span><span>${name}</span>`;
                list.appendChild(item);
            });
        }

        function updatePeopleList() {
  const container = document.getElementById('peopleContainer');
  container.innerHTML = '';
  const weekKey = getWeekKey();
  const weekVac = vacations[weekKey] || {};

  (people || []).forEach(name => {
    const wrap = document.createElement('div');
    wrap.className = 'person-item' + (weekVac[name] ? ' on-vacation' : '');

    const left = document.createElement('div');
    left.className = 'person-item-content';

    // Nom (label) ou input en mode √©dition
    const nameBox = document.createElement('div');
    nameBox.style.display = 'flex';
    nameBox.style.alignItems = 'center';
    nameBox.style.gap = '8px';
    nameBox.style.flex = '1';

    const nameLabel = document.createElement('div');
    nameLabel.className = 'person-item-name';
    nameLabel.textContent = name;

    if (weekVac[name]) {
      const tag = document.createElement('span');
      tag.style.marginLeft = '8px';
      tag.style.fontSize = '0.85em';
      tag.style.color = '#8d6e63';
      tag.textContent = '(en vacances)';
      nameLabel.appendChild(tag);
    }

    nameBox.appendChild(nameLabel);

    const right = document.createElement('div');
    right.className = 'item-actions';

    // Checkbox vacances
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'vacation-checkbox';
    cb.checked = !!weekVac[name];
    cb.id = `vac-${name}`;
    cb.addEventListener('change', () => toggleVacation(name));

    const lab = document.createElement('label');
    lab.className = 'vacation-label';
    lab.setAttribute('for', `vac-${name}`);
    lab.textContent = 'Vacances';

    // Bouton √âditer
    const editBtn = document.createElement('button');
    editBtn.className = 'icon-btn';
    editBtn.title = 'Renommer';
    editBtn.innerText = '‚úèÔ∏è';

    editBtn.addEventListener('click', () => {
      // Remplacer le label par un input
      const input = document.createElement('input');
      input.type = 'text';
      input.value = name;
      input.className = 'inline-edit';
      nameBox.replaceChild(input, nameLabel);
      input.focus();
      input.select();

      const commit = () => {
        const newVal = input.value.trim();
        nameBox.replaceChild(nameLabel, input);
        if (newVal && newVal !== name) {
          renamePerson(name, newVal);
        }
      };
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') commit();
        if (e.key === 'Escape') nameBox.replaceChild(nameLabel, input);
      });
      input.addEventListener('blur', commit);
    });

    left.appendChild(nameBox);
    right.appendChild(cb);
    right.appendChild(lab);
    right.appendChild(editBtn);

    wrap.appendChild(left);
    wrap.appendChild(right);
    container.appendChild(wrap);
  });
}

        function refreshModalOptions() {
            const weekKey = getWeekKey();
            const weekVac = vacations[weekKey] || {};
            const personSel = document.getElementById('modalPerson');
            const taskSel = document.getElementById('modalTask');
            personSel.innerHTML = '';
            (people || []).forEach(p => { if (!weekVac[p]) { const opt=document.createElement('option'); opt.value=p; opt.textContent=p; personSel.appendChild(opt); } });
            taskSel.innerHTML = '';
            (tasks || []).forEach(t => { const opt=document.createElement('option'); opt.value=t.name; opt.textContent=t.name; opt.dataset.category=t.category; taskSel.appendChild(opt); });
        }

        // === Panel, t√¢ches & personnes ===
        function togglePanel() { document.getElementById('sidePanel').classList.toggle('active'); }

        function updateTasksList() {
  const container = document.getElementById('tasksContainer');
  container.innerHTML = '';

  (tasks || []).forEach(t => {
    const el = document.createElement('div');
    el.className = `task-item task-${t.category}`;

    // Nom ou input
    const nameBox = document.createElement('div');
    nameBox.style.display = 'flex';
    nameBox.style.alignItems = 'center';
    nameBox.style.gap = '8px';
    nameBox.style.flex = '1';

    const nameLabel = document.createElement('span');
    nameLabel.textContent = t.name;
    nameBox.appendChild(nameLabel);

    const actions = document.createElement('div');
    actions.className = 'item-actions';

    // Bouton √âditer
    const editBtn = document.createElement('button');
    editBtn.className = 'icon-btn';
    editBtn.title = 'Renommer';
    editBtn.innerText = '‚úèÔ∏è';

    editBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = t.name;
      input.className = 'inline-edit';
      nameBox.replaceChild(input, nameLabel);
      input.focus(); input.select();

      const oldName = t.name;
      const commit = () => {
        const newVal = input.value.trim();
        nameBox.replaceChild(nameLabel, input);
        if (newVal && newVal !== oldName) {
          renameTask(oldName, newVal);
        }
      };
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') commit();
        if (e.key === 'Escape') nameBox.replaceChild(nameLabel, input);
      });
      input.addEventListener('blur', commit);
    });

    // Bouton Supprimer (inchang√©, mais on garde)
    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = 'Supprimer';
    delBtn.addEventListener('click', () => {
      // Retirer de la liste
      tasks = tasks.filter(x => !(x.name === t.name && x.category === t.category));
      localStorage.setItem('tasks', JSON.stringify(tasks));
      saveListsToCloud();
      // Option : supprimer les attributions existantes de cette t√¢che ? (si tu veux)
      // document.querySelectorAll('.assignment').forEach(a=>{
      //   const taskEl = a.querySelector('.assignment-task');
      //   if (taskEl && taskEl.textContent === t.name) a.remove();
      // });
      // savePlanning();
      updateTasksList();
      refreshModalOptions();
    });

    el.appendChild(nameBox);
    actions.appendChild(editBtn);
    actions.appendChild(delBtn);
    el.appendChild(actions);

    container.appendChild(el);
  });
}

        window.addPerson = function addPerson() {
            const inp = document.getElementById('newPersonName');
            const name = inp.value.trim(); if (!name) return;
            if (!people.includes(name)) people.push(name);
            localStorage.setItem('people', JSON.stringify(people));
            saveListsToCloud();
            inp.value = '';
            updatePeopleList();
            refreshModalOptions();
        }

        window.addTask = function addTask() {
            const name = document.getElementById('newTaskName').value.trim();
            const category = document.getElementById('newTaskCategory').value;
            if (!name) return;
            tasks.push({ name, category });
            localStorage.setItem('tasks', JSON.stringify(tasks));
            saveListsToCloud();
            document.getElementById('newTaskName').value = '';
            updateTasksList();
            refreshModalOptions();
        }

        // === Modal Attribution ===
        window.openAssignmentModal = function openAssignmentModal() {
            document.getElementById('assignmentModal').classList.add('active');
            refreshModalOptions();
        }
        window.closeAssignmentModal = function closeAssignmentModal() {
            document.getElementById('assignmentModal').classList.remove('active');
        }

        window.saveAssignment = function saveAssignment() {
            const day = document.getElementById('modalDay').value;
            const period = document.getElementById('modalPeriod').value;
            const person = document.getElementById('modalPerson').value;
            const taskSel = document.getElementById('modalTask');
            const task = taskSel.value;
            const category = taskSel.selectedOptions[0]?.dataset?.category || 'autre';
            const weekVac = vacations[getWeekKey()] || {};
            if (weekVac[person]) { alert(`${person} est en vacances cette semaine.`); return; }
            const slot = document.querySelector(`.slot[data-day="${day}"][data-period="${period}"]`);
            if (!slot) return;
            const ass = renderAssignment({ person, task, category });
            slot.appendChild(ass);
            savePlanning();
            closeAssignmentModal();
        }

        // === Drag & Drop (d√©placement des attributions existantes) ===
        function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function dragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function drop(e) {
            e.preventDefault();
            const slot = e.currentTarget; slot.classList.remove('drag-over');
            if (!draggedElem) return; // on d√©place uniquement des .assignment
            const person = draggedElem.querySelector('.assignment-person')?.textContent || '';
            const weekVac = vacations[getWeekKey()] || {};
            if (weekVac[person]) { alert(`${person} est en vacances cette semaine.`); return; }
            slot.appendChild(draggedElem);
            savePlanning();
        }

        // === Outils ===
        window.clearWeek = function clearWeek() {
            if (!confirm('Effacer toutes les attributions de la semaine ?')) return;
            clearSlotsOnly();
            savePlanning();
        }

        window.exportPlanning = function exportPlanning() {
            const data = buildWeekPlanningFromDOM();
            const blob = new Blob([JSON.stringify({ week: getWeekKey(), data }, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `planning-${getWeekKey()}.json`; a.click();
            URL.revokeObjectURL(url);
        }

        // Expose quelques fonctions globales n√©cessaires aux boutons inline
        window.togglePanel = togglePanel;
        window.changeWeek = changeWeek;
        // Suppression par d√©l√©gation (desktop + mobile)
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.remove-btn');
  if (!btn) return;
  e.preventDefault();
  e.stopPropagation();
  const card = btn.closest('.assignment');
  if (card) {
    card.remove();
    savePlanning(); // pousse la modif (local + Firestore temps r√©el)
  }
});

// iOS Safari : assurer le d√©clenchement via touch (et bloquer le drag fant√¥me)
document.addEventListener('touchstart', (e) => {
  const btn = e.target.closest('.remove-btn');
  if (!btn) return;
  e.preventDefault(); // √©vite que le touch devienne un drag
  btn.click();        // d√©clenche le handler ci-dessus
}, { passive: false });
    </script>
</body>
</html>
