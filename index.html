<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planning de garde - Grand-père</title>
    <style>
        /* ... ton CSS complet inchangé ... */
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelectorAll("link[rel='stylesheet'], script[src]").forEach(el => {
                const attr = el.tagName === "LINK" ? "href" : "src";
                el.setAttribute(attr, el.getAttribute(attr) + "?v=" + new Date().getTime());
            });
        });
    </script>
</head>
<body>
    <!-- ... ton HTML du tableau, side-panel, modals, etc. inchangé ... -->

    <script>
        // === Données ===
        let currentWeekOffset = 0;
        let people = ['Marie', 'Pierre', 'Jean', 'Sophie', 'Paul'];
        let tasks = [ /* ... tes tâches par défaut ... */ ];
        let planning = {};
        let draggedData = null;

        document.addEventListener('DOMContentLoaded', () => { initTable(); });

        function initTable() {
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const headerRow = document.getElementById('headerRow');
            const morningRow = document.getElementById('morningRow');
            const afternoonRow = document.getElementById('afternoonRow');

            days.forEach((day) => {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);

                const morningTd = document.createElement('td');
                morningTd.className = 'slot';
                morningTd.dataset.day = day;
                morningTd.dataset.period = 'morning';
                morningTd.ondrop = drop;
                morningTd.ondragover = allowDrop;
                morningTd.ondragleave = dragLeave;
                morningRow.appendChild(morningTd);

                const afternoonTd = document.createElement('td');
                afternoonTd.className = 'slot';
                afternoonTd.dataset.day = day;
                afternoonTd.dataset.period = 'afternoon';
                afternoonTd.ondrop = drop;
                afternoonTd.ondragover = allowDrop;
                afternoonTd.ondragleave = dragLeave;
                afternoonRow.appendChild(afternoonTd);
            });

            loadSavedData();
            updateWeekDisplay();
            loadPlanning();
            updatePeopleList();
            updateTasksList();
            refreshModalOptions();
        }

        function getWeekDates() {
            const today = new Date();
            const currentDay = today.getDay() || 7;
            const monday = new Date(today);
            monday.setHours(0, 0, 0, 0);
            monday.setDate(today.getDate() - currentDay + 1 + currentWeekOffset * 7);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            return { start: monday, end: sunday, key: `${monday.getFullYear()}-${monday.getMonth()}-${monday.getDate()}` };
        }

        function updateWeekDisplay() {
            const dates = getWeekDates();
            const options = { day: 'numeric', month: 'short' };
            document.getElementById('weekDisplay').textContent =
                `${dates.start.toLocaleDateString('fr-FR', options)} - ${dates.end.toLocaleDateString('fr-FR', options)}`;
        }

        function changeWeek(offset) {
            savePlanning();
            currentWeekOffset += offset;
            updateWeekDisplay();
            loadPlanning();
        }

        function loadSavedData() {
            const sp = localStorage.getItem('people');
            if (sp) people = JSON.parse(sp);
            const st = localStorage.getItem('tasks');
            if (st) tasks = JSON.parse(st);
        }

        function togglePanel() {
            document.getElementById('sidePanel').classList.toggle('active');
        }

        /* ... tes fonctions updatePeopleList, addPerson, deletePerson, updateTasksList, addTask, deleteTask, drag&drop, addAssignmentToSlot, modals, etc. inchangées ... */

        function clearWeek() {
            if (!confirm('Effacer toutes les attributions de la semaine affichée ?')) return;
            document.querySelectorAll('.slot').forEach((slot) => (slot.innerHTML = ''));
            savePlanning();
        }

        function exportPlanning() {
            savePlanning();
            const weekKey = getWeekDates().key;
            const data = planning[weekKey] || {};
            const blob = new Blob([JSON.stringify({ weekKey, data }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `planning-${weekKey}.json`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
        }
    </script>

    <!-- === Firestore Intégration === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2MjMWssWKh74NIru2wAvR3rPZ6eFH854",
            authDomain: "plnning-familial.firebaseapp.com",
            projectId: "plnning-familial",
            storageBucket: "plnning-familial.firebasestorage.app",
            messagingSenderId: "97302700143",
            appId: "1:97302700143:web:f50693e7cd5ef514a4ed9a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.savePlanning = async function () {
            const weekKey = getWeekDates().key;
            const weekPlanning = {};
            document.querySelectorAll('.slot').forEach((slot) => {
                const day = slot.dataset.day;
                const period = slot.dataset.period;
                const assignments = Array.from(slot.querySelectorAll('.assignment')).map((el) => {
                    const person = el.querySelector('.assignment-person').textContent;
                    const task = el.querySelector('.assignment-task').textContent;
                    const category = Array.from(el.classList).find((c) => c.startsWith('task-'))?.replace('task-', '') || 'autre';
                    return { person, task, category };
                });
                if (!weekPlanning[day]) weekPlanning[day] = {};
                weekPlanning[day][period] = assignments;
            });

            try {
                await setDoc(doc(db, "plannings", weekKey), { data: weekPlanning });
                console.log("Planning sauvegardé sur Firestore ✅");
            } catch (err) {
                console.error("Erreur Firestore, stockage local utilisé :", err);
                localStorage.setItem('planning', JSON.stringify({ [weekKey]: weekPlanning }));
            }
        };

        window.loadPlanning = async function () {
            const weekKey = getWeekDates().key;
            let weekPlanning = null;

            try {
                const docSnap = await getDoc(doc(db, "plannings", weekKey));
                if (docSnap.exists()) {
                    weekPlanning = docSnap.data().data;
                    console.log("Planning chargé depuis Firestore ✅");
                } else {
                    console.log("Aucun planning Firestore, vérification localStorage...");
                }
            } catch (err) {
                console.error("Erreur Firestore, récupération locale :", err);
            }

            if (!weekPlanning) {
                const saved = localStorage.getItem('planning');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    weekPlanning = parsed[weekKey] || {};
                } else {
                    weekPlanning = {};
                }
            }

            document.querySelectorAll('.slot').forEach((slot) => {
                slot.innerHTML = '';
                const day = slot.dataset.day;
                const period = slot.dataset.period;
                if (weekPlanning[day] && weekPlanning[day][period]) {
                    weekPlanning[day][period].forEach((assignment) => {
                        addAssignmentToSlot(slot, assignment.person, assignment.task, assignment.category);
                    });
                }
            });
        };
    </script>
</body>
</html>
